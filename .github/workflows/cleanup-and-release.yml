name: Clean and Release to Master

on:
  workflow_dispatch:
    inputs:
      keep_commits:
        description: 'Comma-separated list of commit SHAs to keep in chronological order (oldest to newest)'
        required: false
        default: 'aa34f0f75076cdba86b12aa8e8c8e100610b0c8d,7bb39c2a58ab61d933a102fee7bd5e52af1e1759'
      squashed_commit_message:
        description: 'Message for the squashed commit'
        required: false
        default: 'chore: workflow improvements and bug fixes'
      backup_old_dev:
        description: 'Create backup of old dev branch?'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  cleanup-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Backup old dev branch
        id: backup
        if: ${{ inputs.backup_old_dev == true }}
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BACKUP_BRANCH="dev-backup-${TIMESTAMP}"
          
          git checkout -b "$BACKUP_BRANCH"
          git push origin "$BACKUP_BRANCH"
          
          echo "‚úÖ Created backup branch: $BACKUP_BRANCH"
          echo "backup_branch=$BACKUP_BRANCH" >> $GITHUB_OUTPUT
          
          git checkout dev

      - name: Analyze commits
        id: analyze
        run: |
          # Get list of commits to keep
          IFS=',' read -ra KEEP_COMMITS <<< "${{ inputs.keep_commits }}"
          
          echo "Commits to keep:"
          for commit in "${KEEP_COMMITS[@]}"; do
            commit=$(echo "$commit" | xargs) # trim whitespace
            echo "  - $commit: $(git log --oneline -1 $commit)"
          done
          
          echo ""
          echo "==================================="
          echo "All commits on dev branch:"
          echo "==================================="
          git log --oneline
          echo "==================================="

      - name: Create clean history
        run: |
          # Get list of commits to keep (trimmed)
          IFS=',' read -ra KEEP_COMMITS <<< "${{ inputs.keep_commits }}"
          KEEP_COMMITS=("${KEEP_COMMITS[@]//[[:space:]]/}")
          
          # Find the oldest commit we're keeping
          OLDEST_KEEP=""
          for commit in "${KEEP_COMMITS[@]}"; do
            if [ -z "$OLDEST_KEEP" ]; then
              OLDEST_KEEP="$commit"
            else
              # Check if this commit is older than our current oldest
              if git merge-base --is-ancestor "$commit" "$OLDEST_KEEP" 2>/dev/null; then
                OLDEST_KEEP="$commit"
              fi
            fi
          done
          
          echo "Oldest commit to keep: $OLDEST_KEEP"
          
          # Get the parent of the oldest commit (this is where we'll start fresh)
          BASE_COMMIT=$(git rev-parse ${OLDEST_KEEP}^)
          echo "Base commit (parent): $BASE_COMMIT"
          
          # Create a new branch from base
          git checkout -b dev-clean $BASE_COMMIT
          
          # Cherry-pick each commit we want to keep, in order
          echo ""
          echo "Cherry-picking commits to keep..."
          for commit in "${KEEP_COMMITS[@]}"; do
            echo "Cherry-picking: $commit"
            
            # Check if this is a merge commit
            PARENT_COUNT=$(git cat-file -p $commit | grep "^parent" | wc -l)
            
            if [ "$PARENT_COUNT" -gt 1 ]; then
              echo "  ‚Ñπ Merge commit detected - using mainline parent"
              if git cherry-pick -m 1 $commit 2>&1 | tee /tmp/cherry-pick-output.txt; then
                echo "  ‚úì Success"
              else
                # Check if it's an empty commit
                if grep -q "previous cherry-pick is now empty" /tmp/cherry-pick-output.txt; then
                  echo "  ‚Ñπ Empty merge commit - skipping"
                  git cherry-pick --skip
                else
                  echo "  ‚ö† Conflict - applying manually"
                  git checkout --theirs . 2>/dev/null || true
                  git add -A
                  git cherry-pick --continue --no-edit 2>/dev/null || git cherry-pick --skip
                fi
              fi
            else
              if git cherry-pick $commit; then
                echo "  ‚úì Success"
              else
                echo "  ‚ö† Conflict - applying manually"
                git checkout --theirs . 2>/dev/null || true
                git add -A
                git cherry-pick --continue --no-edit 2>/dev/null || git commit --no-edit
              fi
            fi
          done
          
          # Now add all remaining changes as one squashed commit
          git checkout dev
          CURRENT_STATE=$(git write-tree)
          git checkout dev-clean
          git read-tree $CURRENT_STATE
          
          if ! git diff-index --quiet HEAD; then
            git add -A
            git commit -m "${{ inputs.squashed_commit_message }}"
            echo "‚úì Created squashed commit with remaining changes"
          else
            echo "‚úì No additional changes to squash"
          fi

      - name: Replace dev branch
        run: |
          # Force push the clean branch as dev
          git push origin dev-clean:dev --force
          
          echo "‚úÖ Replaced dev branch with clean history"

      - name: Update master branch
        run: |
          # Update master to match cleaned dev
          git fetch origin master 2>/dev/null || true
          
          if git show-ref --verify --quiet refs/remotes/origin/master; then
            git checkout master
            git reset --hard dev-clean
          else
            git checkout -b master
          fi
          
          git push origin master --force
          
          echo "‚úÖ Updated master branch"

      - name: Cleanup
        run: |
          # Delete temporary branch
          git push origin --delete dev-clean 2>/dev/null || true
          
          echo "‚úÖ Cleaned up temporary branches"

      - name: Summary
        run: |
          git checkout dev
          
          echo "==================================="
          echo "‚úÖ Cleanup Complete!"
          echo "==================================="
          echo ""
          echo "üìã Final commit history:"
          git log --oneline -20
          echo ""
          echo "üìä Summary:"
          echo "  - Kept specified commits"
          echo "  - Squashed all other commits into one"
          echo "  - Master branch updated"
          if [ "${{ inputs.backup_old_dev }}" == "true" ]; then
            echo "  - Backup: ${{ steps.backup.outputs.backup_branch }}"
          fi
          echo ""
          echo "üîç View branches:"
          echo "  - Dev: https://github.com/${{ github.repository }}/tree/dev"
          echo "  - Master: https://github.com/${{ github.repository }}/tree/master"
          if [ "${{ inputs.backup_old_dev }}" == "true" ]; then
            echo "  - Backup: https://github.com/${{ github.repository }}/tree/${{ steps.backup.outputs.backup_branch }}"
          fi