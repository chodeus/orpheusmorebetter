name: "Upstream Sync (daily)"

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: upstream-sync
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      updated: ${{ steps.sync.outputs.updated }}
      commit_sha: ${{ steps.sync.outputs.commit_sha }}
      manual_review_needed: ${{ steps.sync.outputs.manual_review_needed }}
      manual_review_files: ${{ steps.sync.outputs.manual_review_files }}
      deleted_files_detected: ${{ steps.sync.outputs.deleted_files_detected }}
      deleted_files: ${{ steps.sync.outputs.deleted_files }}
      diff_stats: ${{ steps.sync.outputs.diff_stats }}
      synced_files: ${{ steps.sync.outputs.synced_files }}
      notification_description: ${{ steps.notification.outputs.description }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync with upstream
        id: sync
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git remote add upstream https://github.com/walkrflocka/orpheusmorebetter.git || git remote set-url upstream https://github.com/walkrflocka/orpheusmorebetter.git
          git fetch upstream master

          LOCAL=$(git rev-parse HEAD)
          REMOTE=$(git rev-parse upstream/master)

          if [ "$LOCAL" != "$REMOTE" ]; then
            echo "üìä Changes detected in upstream"

            UPSTREAM_CHANGES=$(git diff --name-only HEAD upstream/master)
            echo "Upstream changed files:"
            echo "$UPSTREAM_CHANGES"

            AUTO_SYNC_PATTERN='(\.py$|^orpheusmorebetter$|pyproject\.toml|models/|services/|tests/)'
            EXCLUDE_PATTERN='setup\.py'
            IGNORE_PATTERN='(^\.dockerignore$|^\.github/|^Dockerfile$|^README\.md$|^config\.example$|^docker-compose\.yml$|^start\.sh$)'
            FILES_TO_SYNC=$(echo "$UPSTREAM_CHANGES" | grep -E "$AUTO_SYNC_PATTERN" | grep -vE "$EXCLUDE_PATTERN" || true)
            SETUP_CHANGED=$(echo "$UPSTREAM_CHANGES" | grep -E "^setup\.py$" || true)

            if [ -n "$FILES_TO_SYNC" ]; then
              echo "Auto-syncing these files:"
              echo "$FILES_TO_SYNC"

              # Only sync files that exist in upstream (ignore fork-only files)
              FILTERED_FILES=""
              while IFS= read -r f; do
                [ -z "$f" ] && continue
                if git cat-file -e upstream/master:"$f" 2>/dev/null; then
                  if [ -z "$FILTERED_FILES" ]; then
                    FILTERED_FILES="$f"
                  else
                    FILTERED_FILES="$(printf '%s\n%s' "$FILTERED_FILES" "$f")"
                  fi
                else
                  echo "‚ÑπÔ∏è Skipping fork-only file: $f"
                fi
              done <<< "$FILES_TO_SYNC"
              FILES_TO_SYNC="$FILTERED_FILES"

              if [ -z "$FILES_TO_SYNC" ]; then
                echo "‚ÑπÔ∏è No auto-syncable files changed (all were fork-only)"
                echo "updated=false" >> $GITHUB_OUTPUT
              else

              # Capture diff stats and full diff before overwriting files
              DIFF_STATS=""
              while IFS= read -r f; do
                [ -z "$f" ] && continue
                FILE_STAT=$(git diff --stat HEAD upstream/master -- "$f")
                if [ -n "$FILE_STAT" ]; then
                  DIFF_STATS="$(printf '%s%s\n' "$DIFF_STATS" "$FILE_STAT")"
                fi
              done <<< "$FILES_TO_SYNC"
              echo "diff_stats<<EOF" >> $GITHUB_OUTPUT
              echo "$DIFF_STATS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT

              echo "synced_files<<EOF" >> $GITHUB_OUTPUT
              echo "$FILES_TO_SYNC" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT

              mkdir -p /tmp/sync-artifacts
              echo "$FILES_TO_SYNC" | while IFS= read -r f; do [ -n "$f" ] && git diff HEAD upstream/master -- "$f"; done > /tmp/sync-artifacts/upstream-diff.patch

              DELETED_FILES_TMP=$(mktemp)

              echo "$FILES_TO_SYNC" | while IFS= read -r file; do
                if [ -z "$file" ]; then
                  continue
                fi

                if git cat-file -e upstream/master:"$file" 2>/dev/null; then
                  if ! git checkout upstream/master -- "$file" 2>/dev/null; then
                    echo "::warning::Could not checkout $file"
                  fi
                else
                  if [ -e "$file" ]; then
                    echo "‚ö†Ô∏è File/directory deleted upstream: $file"
                    echo "$file" >> "$DELETED_FILES_TMP"
                  fi
                fi
              done

              DELETED_FILES=$(cat "$DELETED_FILES_TMP")
              rm -f "$DELETED_FILES_TMP"

              if [ -n "$DELETED_FILES" ]; then
                echo "deleted_files_detected=true" >> $GITHUB_OUTPUT
                echo "deleted_files<<EOF" >> $GITHUB_OUTPUT
                echo "$DELETED_FILES" >> $GITHUB_OUTPUT
                echo "EOF" >> $GITHUB_OUTPUT
              fi

              git add -A

              if git diff --cached --quiet; then
                echo "‚ÑπÔ∏è No actual changes after sync"
                echo "updated=false" >> $GITHUB_OUTPUT
              else
                git commit -m "chore: auto-sync code files from upstream (excluding setup.py)"

                NEW_LOCAL=$(git rev-parse HEAD)
                if [ "$LOCAL" != "$NEW_LOCAL" ]; then
                  # Push to main (primary branch)
                  git push origin main
                  echo "updated=true" >> $GITHUB_OUTPUT
                  echo "commit_sha=$NEW_LOCAL" >> $GITHUB_OUTPUT
                  echo "‚úÖ Auto-synced code files to main"

                  # Mirror to dev branch to keep them in sync
                  if git push origin HEAD:refs/heads/dev 2>&1; then
                    echo "‚úÖ Also updated dev branch"
                  else
                    echo "::warning::Failed to mirror sync commit to dev branch"
                  fi
                else
                  echo "updated=false" >> $GITHUB_OUTPUT
                fi
              fi
              fi
            else
              echo "‚ÑπÔ∏è No auto-syncable files changed"
              echo "updated=false" >> $GITHUB_OUTPUT
            fi

            MANUAL_REVIEW=$(echo "$UPSTREAM_CHANGES" | grep -vE "$AUTO_SYNC_PATTERN" | grep -vE "$IGNORE_PATTERN" || true)

            if [ -n "$SETUP_CHANGED" ]; then
              echo "‚ö†Ô∏è setup.py changed upstream - needs manual review"
              if [ -z "$MANUAL_REVIEW" ]; then
                MANUAL_REVIEW="setup.py"
              else
                MANUAL_REVIEW=$(echo -e "setup.py\n${MANUAL_REVIEW}")
              fi
            fi

            if [ -n "$MANUAL_REVIEW" ]; then
              echo "‚ö†Ô∏è These files changed but need manual review:"
              echo "$MANUAL_REVIEW"
              echo "manual_review_needed=true" >> $GITHUB_OUTPUT
              echo "manual_review_files<<EOF" >> $GITHUB_OUTPUT
              echo "$MANUAL_REVIEW" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚úÖ Already up to date with upstream"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload diff artifact
        if: steps.sync.outputs.updated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: upstream-diff
          path: /tmp/sync-artifacts/upstream-diff.patch
          retention-days: 30

      - name: Build notification description
        id: notification
        if: always()
        env:
          SYNC_STATUS: ${{ steps.sync.outcome }}
          UPDATED: ${{ steps.sync.outputs.updated }}
          MANUAL_REVIEW_NEEDED: ${{ steps.sync.outputs.manual_review_needed }}
          MANUAL_REVIEW_FILES: ${{ steps.sync.outputs.manual_review_files }}
          DELETED_FILES_DETECTED: ${{ steps.sync.outputs.deleted_files_detected }}
          DELETED_FILES: ${{ steps.sync.outputs.deleted_files }}
          DIFF_STATS: ${{ steps.sync.outputs.diff_stats }}
          SYNCED_FILES: ${{ steps.sync.outputs.synced_files }}
        run: |
          # Start building description
          echo "description<<EOF" >> $GITHUB_OUTPUT

          if [ "$SYNC_STATUS" == "failure" ]; then
            echo "Error during upstream sync." >> $GITHUB_OUTPUT
          elif [ "$UPDATED" == "true" ]; then
            echo "Successfully synced code files from upstream and pushed to main and dev branches." >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            if [ -n "$SYNCED_FILES" ]; then
              echo "**Synced Files:**" >> $GITHUB_OUTPUT
              echo '```' >> $GITHUB_OUTPUT
              echo "$SYNCED_FILES" >> $GITHUB_OUTPUT
              echo '```' >> $GITHUB_OUTPUT
            fi
            if [ -n "$DIFF_STATS" ]; then
              echo "**Changes:**" >> $GITHUB_OUTPUT
              echo '```' >> $GITHUB_OUTPUT
              echo "$DIFF_STATS" >> $GITHUB_OUTPUT
              echo '```' >> $GITHUB_OUTPUT
            fi
            echo "" >> $GITHUB_OUTPUT
            echo "üî® Docker build will be triggered automatically by the push to main/dev." >> $GITHUB_OUTPUT
            echo "üìé Full diff available as workflow artifact." >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "üîí setup.py excluded from auto-sync (maintained separately)." >> $GITHUB_OUTPUT
          else
            echo "Checked upstream repository - already up to date." >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "No sync or build required." >> $GITHUB_OUTPUT
          fi

          if [ "$MANUAL_REVIEW_NEEDED" == "true" ]; then
            echo "" >> $GITHUB_OUTPUT
            echo "**Manual Review Required**" >> $GITHUB_OUTPUT
            echo "Some files changed but need your review:" >> $GITHUB_OUTPUT
            echo '```' >> $GITHUB_OUTPUT
            echo "$MANUAL_REVIEW_FILES" >> $GITHUB_OUTPUT
            echo '```' >> $GITHUB_OUTPUT
          fi

          if [ "$DELETED_FILES_DETECTED" == "true" ]; then
            echo "" >> $GITHUB_OUTPUT
            echo "**Files Deleted Upstream**" >> $GITHUB_OUTPUT
            echo "These files/directories were deleted and need manual removal:" >> $GITHUB_OUTPUT
            echo '```' >> $GITHUB_OUTPUT
            echo "$DELETED_FILES" >> $GITHUB_OUTPUT
            echo '```' >> $GITHUB_OUTPUT
          fi

          echo "EOF" >> $GITHUB_OUTPUT

  log-sync:
    needs: sync
    if: always() && (needs.sync.result == 'failure' || needs.sync.outputs.updated == 'true' || needs.sync.outputs.manual_review_needed == 'true' || needs.sync.outputs.deleted_files_detected == 'true')
    uses: ./.github/workflows/logging.yml
    with:
      event_type: 'sync'
      status: ${{ needs.sync.result == 'failure' && 'failure' || (needs.sync.outputs.updated == 'true' && 'success' || 'info') }}
      title: ${{ needs.sync.result == 'failure' && 'Upstream Sync Failed' || (needs.sync.outputs.updated == 'true' && 'Code Auto-Synced from Upstream' || 'No Changes Detected') }}
      description: ${{ needs.sync.outputs.notification_description }}
      sync_updated: ${{ needs.sync.outputs.updated }}
      manual_review_needed: ${{ needs.sync.outputs.manual_review_needed }}
      manual_review_files: ${{ needs.sync.outputs.manual_review_files }}
      deleted_files_detected: ${{ needs.sync.outputs.deleted_files_detected }}
      deleted_files: ${{ needs.sync.outputs.deleted_files }}
      include_commit_link: false
    secrets:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
